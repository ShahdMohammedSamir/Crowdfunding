{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <!-- Project Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold text-dark mb-2">{{ project.title }}</h1>
            <p class="text-muted mb-0">
                <i class="fas fa-user-circle me-1" style="color: #0d6efd;"></i>By {{ project.user.get_full_name }} 
                <i class="fas fa-tag ms-3 me-1" style="color: #0d6efd;"></i>{{ project.category.name }} 
                <i class="fas fa-calendar ms-3 me-1" style="color: #0d6efd;"></i>{{ project.created_at|date }}
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            {% if project.user == request.user and project.can_cancel %}
                <form method="post" action="{% url 'cancel_project' project.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-warning">
                        <i class="fas fa-times-circle me-2"></i>Cancel Project
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    
    <!-- Image Slider -->
    {% if project.pictures.all %}
    <div class="card border-0 shadow-sm mb-4">
        <div id="projectCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner rounded-3">
                {% for picture in project.pictures.all %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ picture.image.url }}" class="d-block w-100" alt="{{ project.title }}" style="height: 450px; object-fit: cover;">
                    </div>
                {% endfor %}
            </div>
            {% if project.pictures.all|length > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#projectCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#projectCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Project Details -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4" style="color: #0d6efd;">
                        <i class="fas fa-info-circle me-2"></i>About This Project
                    </h3>
                    <p class="card-text lead">{{ project.details }}</p>
                    
                    {% if project.tags.all %}
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        {% for tag in project.tags.all %}
                            <span class="badge px-3 py-2" style="background: rgba(13, 110, 253, 0.1); color: #0d6efd;">
                                <i class="fas fa-hashtag me-1"></i>{{ tag.name }}
                            </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle me-3" style="background: rgba(13, 110, 253, 0.1);">
                                    <i class="fas fa-play-circle fa-lg" style="color: #0d6efd;"></i>
                                </div>
                                <div>
                                    <p class="mb-0 text-muted small">Start Date</p>
                                    <p class="mb-0 fw-semibold">{{ project.start_time|date }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle me-3" style="background: rgba(13, 110, 253, 0.1);">
                                    <i class="fas fa-stop-circle fa-lg" style="color: #0d6efd;"></i>
                                </div>
                                <div>
                                    <p class="mb-0 text-muted small">End Date</p>
                                    <p class="mb-0 fw-semibold">{{ project.end_time|date }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle me-3" style="background: rgba(13, 110, 253, 0.1);">
                                    <i class="fas fa-tag fa-lg" style="color: #0d6efd;"></i>
                                </div>
                                <div>
                                    <p class="mb-0 text-muted small">Status</p>
                                    <p class="mb-0">
                                        {% if project.is_cancelled %}
                                            <span class="badge bg-danger">Cancelled</span>
                                        {% elif project.is_running %}
                                            <span class="badge" style="background: #4CAF50; color: white;">Running</span>
                                        {% elif project.is_completed %}
                                            <span class="badge bg-info">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning">Upcoming</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle me-3" style="background: rgba(13, 110, 253, 0.1);">
                                    <i class="fas fa-star fa-lg" style="color: #0d6efd;"></i>
                                </div>
                                <div>
                                    <p class="mb-0 text-muted small">Average Rating</p>
                                    <p class="mb-0 fw-semibold">
                                        {% if project.average_rating %}
                                            {{ project.average_rating|floatformat:1 }}/5
                                        {% else %}
                                            Not rated yet
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4" style="color: #0d6efd;">
                        <i class="fas fa-chart-line me-2"></i>Funding Progress
                    </h3>
                    
                    <div class="progress mb-3" style="height: 30px; border-radius: 15px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ project.progress_percentage }}%; background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%); border-radius: 15px;" 
                             aria-valuenow="{{ project.progress_percentage }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            <span class="fw-bold">{{ project.progress_percentage|floatformat:1 }}%</span>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <div class="border-end">
                                <p class="mb-1 text-muted">Raised</p>
                                <h4 class="fw-bold" style="color: #4CAF50;">{{ project.current_donations|floatformat:2 }} EGP</h4>
                            </div>
                        </div>
                        <div class="col-6">
                            <p class="mb-1 text-muted">Target</p>
                            <h4 class="text-dark fw-bold">{{ project.total_target|floatformat:2 }} EGP</h4>
                        </div>
                    </div>
                    
                    {% if user.is_authenticated and project.is_running and not project.is_cancelled %}
                        <button class="btn btn-lg w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#donateModal"
                                style="background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%); color: white; border: none;">
                            <i class="fas fa-donate me-2"></i>Support This Project
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Comments Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-4" style="color: #0d6efd;">
                        <i class="fas fa-comments me-2"></i>Comments ({{ project.comments.count }})
                    </h3>
                    
                    {% if user.is_authenticated %}
                        <form method="post" class="mb-4">
                            {% csrf_token %}
                            <input type="hidden" name="comment" value="true">
                            <div class="mb-3">
                                <label for="id_content" class="form-label fw-semibold">Add your comment</label>
                                <textarea name="content" class="form-control" id="id_content" rows="4" 
                                          placeholder="Share your thoughts about this project..." 
                                          style="border-radius: 12px; border: 2px solid #e9ecef;"></textarea>
                            </div>
                            <button type="submit" class="btn px-4 py-2"
                                    style="background: #4CAF50; color: white; border: none;">
                                <i class="fas fa-paper-plane me-2"></i>Post Comment
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Please <a href="{% url 'login' %}" class="alert-link">login</a> to leave a comment.
                        </div>
                    {% endif %}
                    
                    <div class="comments-list mt-4">
                        {% for comment in comments %}
                            {% include 'projects/comment.html' with comment=comment %}
                        {% empty %}
                            <div class="text-center py-4">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Donation Button -->
            {% if user.is_authenticated and project.is_running and not project.is_cancelled %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4 text-center">
                        <div class="p-4 rounded-3 mb-3" style="background: rgba(76, 175, 80, 0.1);">
                            <i class="fas fa-hand-holding-heart fa-3x mb-3" style="color: #4CAF50;"></i>
                            <h4 class="text-dark">Support This Project</h4>
                            <p class="text-muted">Your contribution can make a difference</p>
                        </div>
                        <button class="btn btn-lg w-100 py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#donateModal"
                                style="background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%); color: white; border: none;">
                            <i class="fas fa-donate me-2"></i>Donate Now
                        </button>
                    </div>
                </div>
            {% endif %}
            
            <!-- Rating -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3" style="color: #0d6efd;">
                        <i class="fas fa-star me-2"></i>Rate This Project
                    </h4>
                    {% if user.is_authenticated and project.user != request.user %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="rate" value="true">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Your Rating</label>
                                <div class="d-flex justify-content-between align-items-center">
                                    {% for i in "12345" %}
                                        <div class="text-center">
                                            <input class="form-check-input d-none" type="radio" name="rating" 
                                                   id="rating{{ i }}" value="{{ i }}" 
                                                   {% if user_rating and user_rating.rating == i|add:0 %}checked{% endif %}>
                                            <label class="form-check-label rating-star" for="rating{{ i }}">
                                                <i class="fas fa-star fa-2x {% if user_rating and user_rating.rating >= i|add:0 %}text-warning{% else %}text-muted{% endif %}"></i>
                                            </label>
                                            <div class="small mt-1">{{ i }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <button type="submit" class="btn w-100"
                                    style="background: #0d6efd; color: white; border: none;">
                                <i class="fas fa-star me-2"></i>Submit Rating
                            </button>
                        </form>
                    {% elif user.is_authenticated and project.user == request.user %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            You cannot rate your own project.
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Please <a href="{% url 'login' %}" class="alert-link">login</a> to rate this project.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Report Button -->
            {% if user.is_authenticated and project.user != request.user %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4 text-center">
                        <button class="btn btn-outline-danger report-btn w-100 py-3" 
                                data-report-type="project" 
                                data-content-id="{{ project.id }}">
                            <i class="fas fa-flag me-2"></i>Report Project
                        </button>
                    </div>
                </div>
            {% endif %}
            
            <!-- Similar Projects -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3" style="color: #0d6efd;">
                        <i class="fas fa-lightbulb me-2"></i>Similar Projects
                    </h4>
                    {% for similar in similar_projects %}
                        <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                            <a href="{% url 'project_detail' similar.id %}" class="text-decoration-none text-dark">
                                <div class="row g-2 align-items-center">
                                    <div class="col-4">
                                        {% if similar.pictures.first %}
                                            <img src="{{ similar.pictures.first.image.url }}" alt="{{ similar.title }}" 
                                                 class="img-fluid rounded" style="height: 80px; width: 100%; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                 style="height: 80px;">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-8">
                                        <h6 class="mb-1">{{ similar.title|truncatewords:4 }}</h6>
                                        <div class="progress mb-1" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ similar.progress_percentage }}%; background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%);" 
                                                 aria-valuenow="{{ similar.progress_percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ similar.progress_percentage|floatformat:1 }}% funded</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% empty %}
                        <div class="text-center py-3">
                            <i class="fas fa-search fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">No similar projects found</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Donate Modal -->
<div class="modal fade" id="donateModal" tabindex="-1" aria-labelledby="donateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%); color: white;">
                <h5 class="modal-title" id="donateModalLabel">
                    <i class="fas fa-donate me-2"></i>Donate to {{ project.title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="donate" value="true">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="amount" class="form-label fw-semibold">Donation Amount (EGP)</label>
                        <input type="number" class="form-control form-control-lg" 
                               id="amount" name="amount" min="1" step="0.01" 
                               placeholder="Enter amount" required
                               style="border-radius: 10px; border: 2px solid #e9ecef;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #4CAF50 0%, #0d6efd 100%); border: none;">
                        <i class="fas fa-check me-2"></i>Donate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-flag me-2"></i>Report Content
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="reportForm">
                {% csrf_token %}
                <input type="hidden" name="report" value="true">
                <input type="hidden" name="report_type" id="reportType">
                <input type="hidden" name="content_id" id="contentId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reason" class="form-label fw-semibold">Reason for reporting</label>
                        <textarea class="form-control" id="reason" name="reason" rows="4" 
                                  placeholder="Please explain why you are reporting this content..." 
                                  required style="border-radius: 10px; border: 2px solid #e9ecef;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-paper-plane me-2"></i>Submit Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    
    .progress-bar {
        transition: width 1s ease-in-out;
    }
    
    .rating-star {
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .rating-star:hover {
        transform: scale(1.2);
    }
    
    .form-control {
        border-radius: 12px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .btn {
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .badge {
        border-radius: 10px;
    }
    
    .carousel-control-prev, .carousel-control-next {
        width: 5%;
        opacity: 0.7;
    }
    
    .carousel-control-prev:hover, .carousel-control-next:hover {
        opacity: 1;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    let reportType = null;
    let contentId = null;

    document.querySelectorAll('.report-btn').forEach(button => {
        button.addEventListener('click', function () {
            reportType = this.dataset.reportType;
            contentId = this.dataset.contentId;
            document.getElementById('reportType').value = reportType;
            document.getElementById('contentId').value = contentId;
            document.getElementById('reason').value = "";
            reportModal.show();
        });
    });

    // Handle form submission
    document.getElementById('reportForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);

        fetch("{% url 'report_content' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.item_deleted) {
                    if (reportType === "comment") {
                        const commentEl = document.querySelector(`.comment[data-id='${contentId}']`);
                        if (commentEl) commentEl.remove();
                    } else if (reportType === "project") {
                        const projectEl = document.querySelector(`.project[data-id='${contentId}']`);
                        if (projectEl) projectEl.remove();
                    }
                    alert("Item deleted because it reached 2 reports.");
                } else {  // âœ… Fixed: Added missing closing brace
                    alert("Report submitted successfully.");
                }
                reportModal.hide();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error("Error submitting report:", error);
            alert("Something went wrong. Please try again.");
        });
    });

    // Rating stars interaction
    document.querySelectorAll('.rating-star').forEach(star => {
        star.addEventListener('click', function() {
            const radio = this.previousElementSibling;
            radio.checked = true;
            
            // Update star colors
            const value = parseInt(radio.value);
            document.querySelectorAll('.rating-star i').forEach((icon, index) => {
                if (index < value) {
                    icon.classList.remove('text-muted');
                    icon.classList.add('text-warning');
                } else {
                    icon.classList.remove('text-warning');
                    icon.classList.add('text-muted');
                }
            });
        });
    });
});
</script>
{% endblock %}